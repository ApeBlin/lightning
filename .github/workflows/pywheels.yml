name: Build Python Wheels

on: [push, pull_request]

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-20.04, macos-10.15]

    steps:
      - uses: actions/checkout@v2
      - name: Set up QEMU
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all

      - name: Build wheels
        uses: pypa/cibuildwheel@v1.12.0
        env:
          CIBW_BEFORE_ALL_MACOS: "cd contrib/libhsmd_python && git clone ../../ --recursive src && brew install autoconf automake libtool python3 gmp gnu-sed gettext libsodium sqlite"
          CIBW_BEFORE_ALL_LINUX: "yum install -y gmp-devel zlib-devel valgrind-devel && cd contrib/libhsmd_python && git clone --recursive ../../ src && sed -i 's/ MAP_ANON / 0 /g' src/external/libwally-core/src/ctest/test_psbt_limits.c"
          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux2014"
          CIBW_BUILD: "cp*"
          CIBW_SKIP: "cp2* cp35-* *manylinux_i686"
          CIBW_TEST_REQUIRES: pytest
          CIBW_TEST_COMMAND: pytest {package}/test_libhsmd.py
          CIBW_ARCHS_LINUX: auto aarch64 ppc64le s390x
        with:
          package-dir: "contrib/libhsmd_python"

      - uses: actions/upload-artifact@v2
        with:
          path: "./wheelhouse/*.whl"
